<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Agent</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .hidden { display: none; }
    button { margin: 5px; padding: 10px; }
    .view { margin-top: 20px; }
    canvas { max-width: 600px; }
  </style>
</head>
<body>

  <h2>Dashboard Agent</h2>

  <label for="email">Entrer votre email :</label>
  <input type="email" id="email" placeholder="ex: agent@email.com">
  <button onclick="loadData()">Charger mes données</button>

  <div>
    <button onclick="showView('prod')">Vue Prod</button>
    <button onclick="showView('rh')">Vue RH</button>
    <button onclick="showView('global')">Vue Global</button>
  </div>

  <div id="prod" class="view hidden"></div>
  <div id="rh" class="view hidden"></div>
  <div id="global" class="view hidden">
    <canvas id="chart"></canvas>
  </div>

  <!-- ✅ Charger Tabletop après le chargement de la page -->
  <script src="https://unpkg.com/tabletop@1.5.1/tabletop.js" onload="initTabletop()"></script>
  <!-- ✅ Chart.js pour le graphique -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let dataProd = [], dataRH = [], dataGlobal = [];

    function initTabletop() {
      console.log("Tabletop.js chargé et prêt !");
    }

    function loadData() {
      const email = document.getElementById('email').value.trim().toLowerCase();
      if (!email) return alert("Veuillez entrer une adresse e-mail.");

      Tabletop.init({
        key: 'https://docs.google.com/spreadsheets/d/1aZek6YwzL94ideDVBjiJQF_-Mrtt5hVS3fCnXuGj_7E/pubhtml',
        wanted: ['Prod', 'RH', 'Global'],
        callback: function(data, tabletop) {
          dataProd = data.Prod.elements;
          dataRH = data.RH.elements;
          dataGlobal = data.Global.elements;

          showProd(email);
          showRH(email);
          showGlobal();
        }
      });
    }

    function showView(id) {
      document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    function showProd(email) {
      const container = document.getElementById('prod');
      container.innerHTML = "<h3>Vue Production</h3>";
      const userData = dataProd.find(row => row.Email.toLowerCase() === email);
      if (!userData) return container.innerHTML += "<p>Aucune donnée trouvée.</p>";

      const delta = userData.Pts - userData["Pts Net"];  // Calcul du delta
      container.innerHTML += `
        <p><strong>${userData.Nom || userData.Email}</strong></p>
        <p>Points : ${userData.Pts}</p>
        <p>Points Net : ${userData["Pts Net"]}</p>
        <p>Prime : ${userData.Prime} DT</p>
        <p>Delta : ${delta} points</p>
      `;
    }

    function showRH(email) {
      const container = document.getElementById('rh');
      container.innerHTML = "<h3>Vue RH</h3>";
      const userData = dataRH.find(row => row.Email.toLowerCase() === email);
      if (!userData) return container.innerHTML += "<p>Aucune donnée trouvée.</p>";

      container.innerHTML += `
        <p><strong>${userData.Nom || userData.Email}</strong></p>
        <p>Heures : ${userData.Heures}</p>
        <p>Assiduité : ${userData.Assiduite}</p>
        <p>Congés payés : ${userData.CP}</p>
        <p>TR : ${userData.TR}</p>
        <p>Prime RH : ${userData["Prime RH"]} DT</p>
        <p>Salaire : ${userData.Salaire} DT</p>
      `;
    }

    function showGlobal() {
      const ctx = document.getElementById('chart').getContext('2d');
      const labels = dataGlobal.map(row => "Agent");
      const points = dataGlobal.map(row => parseInt(row.Pts) || 0);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Points',
            data: points,
            backgroundColor: 'rgba(54, 162, 235, 0.5)'
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>

</body>
</html>
