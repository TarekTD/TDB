<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let chartInstance = null;

  async function fetchData(email = "") {
    const baseURL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLheDF7qmltYPePJyU-a_c5NuV479jBixnUIGTjfrfxzS8SW0Ph6HOaBkpvmOwp2nyuP9y_JcBlZDns7PIwz5UPfJVCNQD6lJ9xjLBBJi09BjRG0hyQ3MhGduxflzHekKNZSkhWNhV1OmZIrU-bHn7-HYoJMmf4sUqqM_2MP0je79VDgoZ21CIAfQcDXSlPMdPwWMvEhPf_CbBZ7F2-Y1R0jui7LfwQnObtqb9cpIiD6hVb6ZlvEErw04gnc-SaEIIbMM8_kNpMm3Ol7xERrD_ItYxiXEw&lib=Mm4G-2oZZR9jOqSY09W6cBeaoJlzzZ8rm";
    const url = email ? `${baseURL}&email=${encodeURIComponent(email)}` : baseURL;

    try {
      const res = await fetch(url);
      return await res.json();
    } catch (error) {
      console.error("Erreur lors du chargement des données :", error);
      return null;
    }
  }

  function loadGlobalChart(data) {
    if (!data.global || data.global.length === 0) return;

    document.getElementById("graph").style.display = "block";
    const ctx = document.getElementById("barChart").getContext("2d");

    const labels = data.global.map((_, i) => `Agent ${i + 1}`);
    const values = data.global.map(d => parseFloat(d.nb_pts));

    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "Nb Pts",
          data: values,
          backgroundColor: "#007bff",
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  function displayData(data) {
    if (data.message) {
      document.getElementById("welcome").style.display = "block";
      document.getElementById("welcome").innerText = data.message;
    }

    if (data.prod) {
      const pointsList = data.global
        .map(d => parseFloat(d.nb_pts))
        .filter(v => !isNaN(v))
        .sort((a, b) => b - a);

      const userPts = parseFloat(data.prod.nb_pts);
      const userRank = pointsList.indexOf(userPts) + 1;

      document.getElementById("prod").style.display = "block";
      document.getElementById("prod").innerHTML = `
        <div class="title">Production</div>
        <div class="row">Nb Pts : ${data.prod.nb_pts}</div>
        <div class="row">Nb Pts Net : ${data.prod.nb_pts_net}</div>
        <div class="row">Prime : ${data.prod.prime}</div>
        <div class="row">Classement : <strong>${data.prod.classement}</strong></div>
        <div class="row">Rang anonyme : ${userRank} / ${pointsList.length}</div>
      `;
    }

    if (data.rh) {
      document.getElementById("rh").style.display = "block";
      document.getElementById("rh").innerHTML = `
        <div class="title">RH</div>
        <div class="row">Heures de connexion : ${data.rh.heures}</div>
        <div class="row">Assiduité : ${data.rh.assiduite}</div>
        <div class="row">CP : ${data.rh.cp}</div>
        <div class="row">TR : ${data.rh.tr}</div>
        <div class="row">Salaire : ${data.rh.salaire}</div>
      `;
    }

    // Toujours charger le graphique même sans e-mail
    loadGlobalChart(data);
  }

  document.getElementById("submitBtn").addEventListener("click", async () => {
    const email = document.getElementById("email").value.trim().toLowerCase();
    if (!email) return;

    const data = await fetchData(email);
    if (data) displayData(data);
  });

  // Charger le graphique global dès le chargement de la page
  window.onload = async () => {
    const data = await fetchData();
    if (data) loadGlobalChart(data);
  };
</script>
