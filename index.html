<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Agent</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .hidden { display: none; }
    button { margin: 5px; padding: 10px; }
    .view { margin-top: 20px; }
    canvas { max-width: 600px; }
    .loading { font-size: 18px; color: #555; }
  </style>
</head>
<body>

  <h2>Dashboard Agent</h2>

  <!-- Champ email pour validation -->
  <div id="email-container">
    <label for="email">Entrer votre email :</label>
    <input type="email" id="email" placeholder="ex: agent@email.com">
    <button onclick="validateEmail()">Valider</button>
  </div>

  <!-- Message de chargement -->
  <div id="loading" class="loading hidden">
    Chargement des données, veuillez patienter...
  </div>

  <!-- Vue Global avec graphique -->
  <div id="global" class="view hidden">
    <canvas id="chart"></canvas>
  </div>

  <!-- Choix de la vue après validation du mail -->
  <div id="view-selection" class="view hidden">
    <button onclick="showView('prod')">Vue Prod</button>
    <button onclick="showView('rh')">Vue RH</button>
  </div>

  <!-- Vue RH -->
  <div id="rh" class="view hidden">
    <button onclick="showView('global')">Retour Global</button>
    <div id="rh-content"></div>
  </div>

  <!-- Vue Prod -->
  <div id="prod" class="view hidden">
    <button onclick="showView('global')">Retour Global</button>
    <div id="prod-content"></div>
  </div>

  <!-- Tabletop.js et Chart.js -->
  <script src="https://unpkg.com/tabletop@1.5.1/tabletop.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let dataProd = [], dataRH = [], dataGlobal = [];
    let tabletopReady = false;
    let currentEmail = "";

    // Fonction pour initier Tabletop et charger les données
    function initTabletop() {
      // Afficher le message de chargement
      document.getElementById('loading').classList.remove('hidden');
      
      Tabletop.init({
        key: 'https://docs.google.com/spreadsheets/d/1aZek6YwzL94ideDVBjiJQF_-Mrtt5hVS3fCnXuGj_7E/pubhtml',
        wanted: ['Prod', 'RH', 'Global'],
        callback: function(data, tabletop) {
          dataProd = data.Prod.elements;
          dataRH = data.RH.elements;
          dataGlobal = data.Global.elements;
          
          tabletopReady = true; // Indiquer que Tabletop a terminé
          console.log("Tabletop.js chargé et prêt !");
          
          // Masquer le message de chargement
          document.getElementById('loading').classList.add('hidden');
          
          showGlobal();  // Afficher la vue Global initialement
        },
        error: function(err) {
          alert("Erreur lors du chargement des données: " + err);
          document.getElementById('loading').classList.add('hidden');
        }
      });
    }

    // Fonction pour valider l'email et charger les données
    function validateEmail() {
      const email = document.getElementById('email').value.trim().toLowerCase();
      if (!email) {
        alert("Veuillez entrer une adresse e-mail.");
        return;
      }
      currentEmail = email;

      // Si Tabletop n'est pas prêt, on attend
      if (!tabletopReady) {
        alert("Les données ne sont pas encore disponibles. Veuillez patienter.");
        return;
      }
      showView('view-selection'); // Afficher les options des vues après validation du mail
    }

    // Afficher une vue spécifique
    function showView(view) {
      document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
      document.getElementById(view).classList.remove('hidden');
    }

    // Afficher la vue Global avec graphique
    function showGlobal() {
      const ctx = document.getElementById('chart').getContext('2d');
      const labels = dataGlobal.map(row => "Agent");
      const points = dataGlobal.map(row => parseInt(row.Pts) || 0);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Points',
            data: points,
            backgroundColor: 'rgba(54, 162, 235, 0.5)'
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Afficher la vue RH pour l'email donné
    function showRH() {
      const container = document.getElementById('rh-content');
      container.innerHTML = "<h3>Vue RH</h3>";

      const userData = dataRH.find(row => row.Email.toLowerCase() === currentEmail);
      if (!userData) {
        container.innerHTML += "<p>Aucune donnée trouvée.</p>";
        return;
      }

      container.innerHTML += `
        <p><strong>${userData.Nom || userData.Email}</strong></p>
        <p>Heures : ${userData.Heures}</p>
        <p>Assiduité : ${userData.Assiduite}</p>
        <p>Congés payés : ${userData.CP}</p>
        <p>TR : ${userData.TR}</p>
        <p>Prime RH : ${userData["Prime RH"]} DT</p>
        <p>Salaire : ${userData.Salaire} DT</p>
      `;
    }

    // Afficher la vue Prod pour l'email donné
    function showProd() {
      const container = document.getElementById('prod-content');
      container.innerHTML = "<h3>Vue Prod</h3>";

      const userData = dataProd.find(row => row.Email.toLowerCase() === currentEmail);
      if (!userData) {
        container.innerHTML += "<p>Aucune donnée trouvée.</p>";
        return;
      }

      const delta = userData.Pts - userData["Pts Net"];  // Calcul du delta
      container.innerHTML += `
        <p><strong>${userData.Nom || userData.Email}</strong></p>
        <p>Points : ${userData.Pts}</p>
        <p>Points Net : ${userData["Pts Net"]}</p>
        <p>Prime : ${userData.Prime} DT</p>
        <p>Delta : ${delta} points</p>
      `;
    }

    // Charger Tabletop dès que le script est chargé
    window.onload = function() {
      initTabletop();
    };

  </script>

</body>
</html>
